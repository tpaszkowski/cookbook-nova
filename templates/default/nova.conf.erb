<%= node["nova"]["custom_template_banner"] %>

[DEFAULT]

# LOGS/STATE
verbose=true
debug=true
<% if node["nova"]["ratelimit"]["api"]["enabled"] -%>
auth_strategy=keystone
<% else -%>
auth_strategy=keystone_nolimit
<% end -%>
dhcpbridge_flagfile=/etc/nova/nova.conf
dhcpbridge=/usr/bin/nova-dhcpbridge
logdir=/var/log/nova
<% if node["nova"]["syslog"]["use"] %>
use_syslog=<%= node["nova"]["syslog"]["use"] %>
syslog_log_facility=<%= node["nova"]["syslog"]["facility"] %>
<% end %>
state_path=/var/lib/nova
lock_path=/var/lock/nova

##### RABBITMQ #####
rabbit_userid=<%= @rabbit_user %>
rabbit_password=<%= @rabbit_password %>
<%= "rabbit_port=#{@rabbit_port}" if @rabbit_port %>
rabbit_host=<%= @rabbit_ipaddress %>
rabbit_virtual_host=<%= @rabbit_virtual_host %>

##### SCHEDULER #####
# scheduler_manager=nova.scheduler.manager.SchedulerManager
compute_scheduler_driver=<%= node["nova"]["scheduler"]["scheduler_driver"] %>
scheduler_available_filters=nova.scheduler.filters.standard_filters
# which filter class names to use for filtering hosts when not specified in the request.
scheduler_default_filters=<%= @scheduler_default_filters %>
node_availability_zone=<%= node["nova"]["config"]["availability_zone"] %>
default_schedule_zone=<%= node["nova"]["config"]["default_schedule_zone"] %>
storage_availability_zone=<%= node["nova"]["config"]["storage_availability_zone"] %>

##### NETWORK #####
<% if node["nova"]["networking_backend"] == "quantum" %>
##### QUANTUM #####
default_floating_pool=floating
network_api_class=nova.network.quantumv2.api.API
quantum_url=<%= @quantum_endpoint.scheme %>://<%= @quantum_endpoint.host %>:<%= @quantum_endpoint.port %><%= @quantum_endpoint.path %>
quantum_auth_strategy=keystone
quantum_admin_tenant_name=<%= @quantum_tenant %>
quantum_admin_username=<%= @quantum_user %>
quantum_admin_password=<%= @quantum_password %>
quantum_admin_auth_url=<%= @identity_endpoint.scheme %>://<%= @identity_endpoint.host %>:<%= @identity_endpoint.port %><%= @identity_endpoint.path %>
service_quantum_metadata_proxy=true
<%= "quantum_metadata_proxy_shared_secret=#{@metadata_secret}" if @metadata_secret %>
<% if node["nova"]["vif_driver"] == "openvswitch" %>
##### Openvswitch VIF ####
linuxnet_interface_driver=nova.network.linux_net.LinuxOVSInterfaceDriver
firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver
<% else %>
##### LinuxBridge VIF ####
<% end %>
<% else %>
##### Legacy ######
multi_host=<%= node["nova"]["network"]["multi_host"] %>
network_manager=<%= node["nova"]["network"]["network_manager"] %>
public_interface=<%= node["nova"]["network"]["public_interface"] %>
fixed_range=<%= node["nova"]["network"]["fixed_range"] %>
dmz_cidr=<%= node["nova"]["network"]["dmz_cidr"] %>
<% if %w(fedora redhat centos).include? node.platform -%>
# https://bugzilla.redhat.com/show_bug.cgi?id=788485 - not released in epel yet
force_dhcp_release=false
<% else -%>
force_dhcp_release=true
<% end -%>
<% if node["nova"]["dhcp_domain"] -%>
dhcp_domain=<%= node["nova"]["dhcp_domain"] %>
<% end %>
send_arp_for_ha=true
use_single_default_gateway=<%= node["nova"]["network"]["use_single_default_gateway"] %>
<% if node["nova"]["libvirt"]["virt_type"] == "qemu" -%>
libvirt_use_virtio_for_bridges=false
<% else -%>
libvirt_use_virtio_for_bridges=true
<% end -%>
vlan_interface=<%= node["nova"]["network"]["vlan_interface"] %>
<% end -%>

##### GLANCE #####
image_service=nova.image.glance.GlanceImageService
glance_api_servers=<%= @glance_api_ipaddress %>:<%= @glance_api_port %>

##### COMPUTE #####
compute_driver=libvirt.LibvirtDriver
compute_manager=nova.compute.manager.ComputeManager
sql_connection=<%= @sql_connection %>
connection_type=libvirt
libvirt_type=<%= node["nova"]["libvirt"]["virt_type"] %>
# Command prefix to use for running commands as root (default: sudo)
rootwrap_config=/etc/nova/rootwrap.conf
# Should unused base images be removed? (default: false)
remove_unused_base_images=<%= node["nova"]["libvirt"]["remove_unused_base_images"] %>
# Unused resized base images younger than this will not be removed (default: 3600)
remove_unused_resized_minimum_age_seconds=<%= node["nova"]["libvirt"]["remove_unused_resized_minimum_age_seconds"] %>
# Unused unresized base images younger than this will not be removed (default: 86400)
remove_unused_original_minimum_age_seconds=<%= node["nova"]["libvirt"]["remove_unused_original_minimum_age_seconds"] %>
# Write a checksum for files in _base to disk (default: false)
checksum_base_images=<%= node["nova"]["libvirt"]["checksum_base_images"] %>

##### VNCPROXY #####
<% if @novncproxy_base_url -%>
novncproxy_base_url=<%= @novncproxy_base_url %>
<% end -%>
<% if @xvpvncproxy_base_url -%>
xvpvncproxy_base_url=<%= @xvpvncproxy_base_url %>
<% end -%>
# This is only required on the server running xvpvncproxy
<% if @xvpvncproxy_bind_host -%>
xvpvncproxy_host=<%= @xvpvncproxy_bind_host %>
<% end -%>
<% if @xvpvncproxy_bind_port -%>
xvpvncproxy_port=<%= @xvpvncproxy_bind_port %>
<% end -%>
vncserver_listen=<%= node["nova"]["libvirt"]["vncserver_listen"] %>
vncserver_proxyclient_address=<%= node["nova"]["libvirt"]["vncserver_proxyclient_address"] %>

##### MISC #####
# force backing images to raw format
force_raw_images=<%= node["nova"]["config"]["force_raw_images"] %>
allow_same_net_traffic=<%= node["nova"]["config"]["allow_same_net_traffic"] %>
osapi_max_limit=<%= node["nova"]["config"]["osapi_max_limit"] %>
snapshot_image_format=<%= node["nova"]["config"]["snapshot_image_format"] %>
start_guests_on_host_boot=<%= node["nova"]["config"]["start_guests_on_host_boot"] %>
resume_guests_state_on_host_boot=<%= node["nova"]["config"]["resume_guests_state_on_host_boot"] %>
# number of security groups per project (default: 10)
quota_security_groups=<%= node["nova"]["config"]["quota_security_groups"] %>
# number of security rules per security group (default: 20)
quota_security_group_rules=<%= node["nova"]["config"]["quota_security_group_rules"] %>

<%- if /FilterScheduler/.match(node["nova"]["scheduler"]["scheduler_driver"]) or
       /MultiScheduler/.match(node["nova"]["scheduler"]["scheduler_driver"]) %>
# FilterScheduler Only Options
<%- if /ComputeFilter/.match(@scheduler_default_filters) %>
# virtual CPU to Physical CPU allocation ratio (default: 16.0)
cpu_allocation_ratio=<%= node["nova"]["config"]["cpu_allocation_ratio"] %>
<%- end %>
<%- if /RamFilter/.match(@scheduler_default_filters) %>
# virtual ram to physical ram allocation ratio (default: 1.5)
ram_allocation_ratio=<%= node["nova"]["config"]["ram_allocation_ratio"] %>
<%- end %>
<%- elsif /SimpleScheduler/.match(node["nova"]["scheduler"]["scheduler_driver"]) %>
# SimpleScheduler Only Options
# maximum number of instance cores to allow per host
max_cores=<%= node["nova"]["config"]["cpu_allocation_ratio"].to_i * node["cpu"]["total"].to_i %>
<%- end %>

<% if %w(fedora redhat centos).include? node.platform -%>
# Adding support for non-modded euca2ools to display ip address info
# https://bugs.launchpad.net/nova/+bug/901594
ec2_private_dns_show_ip=True
<% end -%>

##### WORKERS ######
ec2_workers=<%= node["cpu"]["total"] %>
osapi_compute_workers=<%= node["cpu"]["total"] %>
metadata_workers=<%= node["cpu"]["total"] %>

##### KEYSTONE #####
keystone_ec2_url=<%= @identity_endpoint.scheme %>://<%= @identity_endpoint.host %>:<%= @identity_endpoint.port %>/v2.0/ec2tokens

##### VOLUMES #####
# iscsi target user-land tool to use
iscsi_helper=<%= @iscsi_helper %>
volume_api_class=<%= node["nova"]["config"]["volume_api_class"] %>
